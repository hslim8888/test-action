name: Create Release
on:
  push:
    # 여기에 branches를 넣으면 or 조건으로 동작함
    # tags 로만 트리거 되는 동작은 github.ref 가 refs/tags/{tag-name} 이고,
    # checkout 을 하면 detached HEAD 상태로 동작함 > 브랜치 정보를 구할 수 없음.
    tags:
      - 'trigger*'

jobs:
  release:
#    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      # tag format: trigger-ecs|worker-{timestamp}-{username}
      - name: Get triggered tag
        id: trigger_tag
        run: |
          echo ::set-output name=tag::$(git describe --tags --abbrev=0 | grep trigger)
          echo ::set-output name=commit::$(git show-ref -s ${{ steps.trigger_tag.outputs.tag }})
          echo ::set-output name=username::$(echo ${{ steps.trigger_tag.outputs.tag }} | cut -d'-' -f4)
          echo ::set-output name=new_tag::$(echo ${{ steps.trigger_tag.outputs.tag }} | cut -d'-' -f2-3)

      - name: print tag and hash
        run: |
          echo ${{ steps.trigger_tag.outputs.tag }}
          echo ${{ steps.trigger_tag.outputs.commit }}

#      - name: delete trigger tag
#        run: |
#          git push origin --delete ${{ steps.trigger_tag.outputs.tag }}

      # git --sort 옵션이 안 됨.
      - name: Get latest release
        id: get_latest_release
        run: |
          echo ::set-output name=latest_release::$(git ls-remote --tags | grep -v trigger | sort -k2 -r | sed -n 1p)
          echo ::set-output name=latest_release_tag::$(echo ${{ steps.get_latest_release.outputs.latest_release }} | cut -f2 | cut -d'/' -f3)
          echo ::set-output name=latest_release_commit::$(echo ${{ steps.get_latest_release.outputs.latest_release }} | cut -f1)

      - name: print the result
        run: |
          echo ${{ steps.get_latest_release.outputs.latest_release }}
          echo ${{ steps.get_latest_release.outputs.latest_release_tag }}
          echo ${{ steps.get_latest_release.outputs.latest_release_commit }}
      

#      - name: Get latest released tag
#        id: get_latest_tag
#        run: |
#          echo ::set-output name=released-tag::$(git tag --sort=-creatordate --merged main | grep -v trigger | sed -n 1p)
#      - name: Get hash of latest released tag
#        if: ${{ steps.get_latest_tag.outputs.released-tag != '' }}
#        run: |
#          echo ::set-output name=released-commit::$(git rev-list -n 1 ${{ steps.get_latest_tag.outputs.released-tag }})
#
#      - name: print tag
#        run: |
#          git ls-remote --tags | grep -v trigger
#
#      - name: print current branch
#        run: |
#          git branch --show-current
#          echo ${{ github.ref }}
#          echo ${{ github.ref_name }}
#
#          echo ${{ github.head_ref }}
#          echo ${{ github.base_ref }}
#
#      - name: print latest released tag and hash
#        run: |
#          git tag --sort=-creatordate
#
##      - name: Get Changelog
##        id: tag_version
##        uses: mathieudutour/github-tag-action@v6.1
##        with:
##          github_token: ${{ secrets.GITHUB_TOKEN }}
##          custom_tag: ${{ steps.split_tag.outputs.tag }}
##          tag_prefix: ''
